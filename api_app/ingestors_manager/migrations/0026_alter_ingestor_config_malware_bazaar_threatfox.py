from django.db import migrations


def migrate(apps, schema_editor):
    Parameter = apps.get_model("api_app", "Parameter")
    PythonModule = apps.get_model("api_app", "PythonModule")

    ingestors = [
        "malware_bazaar.MalwareBazaar",
        "threatfox.ThreatFox",
    ]
    for ingestor in ingestors:
        module = PythonModule.objects.get(
            module=ingestor,
            base_path="api_app.ingestors_manager.ingestors",
        )
        Parameter.objects.create(
            name="service_api_key",
            type="str",
            description="Optional API key to connect to abuse.ch services.",
            is_secret=True,
            required=False,
            python_module=module,
        )


def reverse_migrate(apps, schema_editor):
    Parameter = apps.get_model("api_app", "Parameter")
    PythonModule = apps.get_model("api_app", "PythonModule")

    ingestors = [
        "malware_bazaar.MalwareBazaar",
        "threatfox.ThreatFox",
    ]
    for ingestor in ingestors:
        module = PythonModule.objects.get(
            module=ingestor,
            base_path="api_app.ingestors_manager.ingestors",
        )
        Parameter.objects.get(
            name="service_api_key",
            type="str",
            description="Optional API key to connect to abuse.ch services.",
            is_secret=True,
            required=False,
            python_module=module,
        ).delete()


class Migration(migrations.Migration):
    atomic = False
    dependencies = [
        ("api_app", "0065_job_mpnodesearch"),
        ("ingestors_manager", "0025_ingestor_config_virustotal_example_query"),
    ]

    operations = [migrations.RunPython(migrate, reverse_migrate)]
