#!/bin/bash
mkdir -p ${LOG_PATH}
touch ${LOG_PATH}/gunicorn_access.log ${LOG_PATH}/gunicorn_errors.log
chown -R malware_tools_analyzers-user:malware_tools_analyzers-user ${LOG_PATH}
# clamav processes
echo "running freshclam"
freshclam # download db for first time
freshclam -d & # run updater in bg
echo "running clamd"
clamd --debug & # run daemon in bg
# change user
su malware_tools_analyzers-user -s /bin/bash
echo "running fangfrisch"
/opt/deploy/flask/venv/bin/fangfrisch --conf /etc/clamav/fangfrisch.conf initdb --force
/opt/deploy/flask/venv/bin/fangfrisch --conf /etc/clamav/fangfrisch.conf refresh &
# start flask server
exec /opt/deploy/flask/venv/bin/gunicorn 'app:app' \
    --bind '0.0.0.0:4002' \
    --user malware_tools_analyzers-user \
    --log-level ${LOG_LEVEL} \
    --access-logfile ${LOG_PATH}/gunicorn_access.log \
    --error-logfile ${LOG_PATH}/gunicorn_errors.log
